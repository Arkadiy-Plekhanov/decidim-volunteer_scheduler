<% add_decidim_page_title(@task_assignment.task_template.title) %>

<!-- Task Assignment Detail Page -->
<div class="volunteer-dashboard-container fade-in">
  <div class="max-w-4xl mx-auto">

    <!-- Back Button -->
    <div class="mb-6">
      <%= link_to decidim_volunteer_scheduler.root_path, class: "button button__sm button__transparent-secondary" do %>
        <%= icon "arrow-left-line", class: "w-4 h-4 mr-1", role: "img" %>
        <%= t(".back_to_dashboard") %>
      <% end %>
    </div>

    <!-- Task Header Card -->
    <div class="card mb-6">
      <div class="card__content p-6">
        <!-- Title and Status -->
        <div class="flex items-start justify-between gap-4 mb-4">
          <div class="flex-1">
            <h1 class="text-3xl font-bold mb-2"><%= @task_assignment.task_template.title %></h1>
            <div class="flex items-center gap-2 text-sm opacity-75">
              <%= icon "calendar-line", class: "w-4 h-4", role: "img" %>
              <span><%= t(".assigned_on", date: l(@task_assignment.assigned_at, format: :long)) %></span>
            </div>
          </div>

          <!-- Status Badge -->
          <span class="label <%= assignment_status_class(@task_assignment) %> text-lg px-4 py-2">
            <%= icon assignment_status_icon(@task_assignment), class: "w-5 h-5", role: "img" %>
            <%= t("decidim.volunteer_scheduler.task_assignments.status.#{@task_assignment.status}") %>
          </span>
        </div>

        <!-- Task Description -->
        <div class="prose max-w-none mb-6">
          <p class="text-lg"><%= @task_assignment.task_template.description %></p>
        </div>

        <!-- Task Metadata Grid -->
        <div class="statistic__container">
          <!-- XP Reward -->
          <div class="statistic">
            <div class="statistic__header">
              <div class="statistic__title"><%= t(".reward") %></div>
              <div class="statistic__icon">
                <%= icon "star-line", role: "img" %>
              </div>
            </div>
            <div class="statistic__number"><%= @task_assignment.task_template.xp_reward %></div>
            <div class="statistic__second-number"><%= t("decidim.volunteer_scheduler.common.xp") %></div>
          </div>

          <!-- Level Required -->
          <div class="statistic">
            <div class="statistic__header">
              <div class="statistic__title"><%= t(".level_required") %></div>
              <div class="statistic__icon">
                <%= icon "trophy-line", role: "img" %>
              </div>
            </div>
            <div class="statistic__number"><%= @task_assignment.task_template.level_required %></div>
            <div class="statistic__second-number">
              <%= t("decidim.volunteer_scheduler.categories.#{@task_assignment.task_template.category}",
                    default: @task_assignment.task_template.category) %>
            </div>
          </div>

          <% if @task_assignment.due_date %>
            <!-- Due Date -->
            <div class="statistic">
              <div class="statistic__header">
                <div class="statistic__title"><%= t(".due_date") %></div>
                <div class="statistic__icon">
                  <%= icon "calendar-line", role: "img" %>
                </div>
              </div>
              <div class="statistic__number text-xl">
                <%= l(@task_assignment.due_date, format: :short) %>
              </div>
              <div class="statistic__second-number">
                <%= days_until_due(@task_assignment) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Action Buttons based on status -->
    <% if @task_assignment.pending? %>
      <div class="card mb-6">
        <div class="card__content p-6">
          <h2 class="text-xl font-bold mb-4">
            <%= icon "upload-line", class: "w-5 h-5 mr-2", role: "img" %>
            <%= t(".submit_work") %>
          </h2>

          <%= form_with model: @task_assignment, url: submit_task_assignment_path(@task_assignment), method: :patch, local: true, multipart: true do |form| %>
            <div class="mb-4">
              <%= form.label :submission_notes, t(".completion_notes"), class: "block font-semibold mb-2" %>
              <%= form.text_area :submission_notes,
                                 rows: 6,
                                 class: "form-control w-full",
                                 placeholder: t(".completion_notes_placeholder"),
                                 required: true %>
              <p class="text-sm opacity-75 mt-1"><%= t(".completion_notes_help") %></p>
            </div>

            <div class="mb-4">
              <%= form.label :hours_worked, t(".hours_worked"), class: "block font-semibold mb-2" %>
              <%= form.number_field :hours_worked,
                                   step: 0.5,
                                   min: 0,
                                   max: 100,
                                   class: "form-control",
                                   placeholder: "0.0" %>
              <p class="text-sm opacity-75 mt-1"><%= t(".hours_worked_help") %></p>
            </div>

            <div class="mb-4">
              <%= form.label :challenges_faced, t(".challenges_faced"), class: "block font-semibold mb-2" %>
              <%= form.text_area :challenges_faced,
                                 rows: 3,
                                 class: "form-control w-full",
                                 placeholder: t(".challenges_faced_placeholder") %>
              <p class="text-sm opacity-75 mt-1"><%= t(".challenges_faced_help") %></p>
            </div>

            <div class="mb-4">
              <%= form.label :add_documents, t(".attachments"), class: "block font-semibold mb-2" %>
              <%= form.file_field :add_documents,
                                 multiple: true,
                                 class: "form-control",
                                 accept: "image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" %>
              <p class="text-sm opacity-75 mt-1">
                <%= icon "information-line", class: "w-4 h-4 inline", role: "img" %>
                <%= t(".attachments_help") %>
              </p>
            </div>

            <div class="flex gap-3">
              <%= form.submit t(".submit_for_review"),
                             class: "button button__lg button__primary",
                             data: { disable_with: t(".submitting") } %>
            </div>
          <% end %>
        </div>
      </div>

    <% elsif @task_assignment.submitted? %>
      <div class="callout">
        <div class="flex items-start gap-3">
          <%= icon "mail-send-line", class: "w-6 h-6 text-secondary", role: "img" %>
          <div>
            <h3 class="font-bold mb-1"><%= t(".under_review") %></h3>
            <p><%= t(".review_message") %></p>
          </div>
        </div>
      </div>

    <% elsif @task_assignment.approved? %>
      <div class="callout success">
        <div class="flex items-start gap-3">
          <%= icon "checkbox-circle-line", class: "w-6 h-6", role: "img" %>
          <div>
            <h3 class="font-bold mb-1"><%= t(".task_completed_title") %></h3>
            <p><%= t(".task_completed_message", xp: @task_assignment.task_template.xp_reward) %></p>
          </div>
        </div>
      </div>

    <% elsif @task_assignment.rejected? %>
      <div class="callout alert">
        <div class="flex items-start gap-3">
          <%= icon "error-warning-line", class: "w-6 h-6", role: "img" %>
          <div>
            <h3 class="font-bold mb-1"><%= t(".needs_revision") %></h3>
            <% if @task_assignment.admin_notes.present? %>
              <p class="mb-3"><strong><%= t(".admin_feedback") %>:</strong> <%= @task_assignment.admin_notes %></p>
            <% end %>
            <%= link_to t(".resubmit"),
                       task_assignment_path(@task_assignment),
                       class: "button button__sm button__secondary" %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Submission History (if available) -->
    <% if @task_assignment.submission_notes.present? %>
      <div class="card">
        <div class="card__content p-6">
          <h2 class="text-xl font-bold mb-4">
            <%= icon "file-text-line", class: "w-5 h-5 mr-2", role: "img" %>
            <%= t(".your_submission") %>
          </h2>

          <div class="prose max-w-none mb-4">
            <%= simple_format(@task_assignment.submission_notes) %>
          </div>

          <% if @task_assignment.submission_data.present? %>
            <div class="grid grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded">
              <% if @task_assignment.submission_data["hours_worked"].present? %>
                <div>
                  <span class="text-sm font-semibold"><%= t(".hours_worked") %>:</span>
                  <span class="text-sm"><%= @task_assignment.submission_data["hours_worked"] %> <%= t(".hours") %></span>
                </div>
              <% end %>

              <% if @task_assignment.submission_data["challenges_faced"].present? %>
                <div class="col-span-2">
                  <span class="text-sm font-semibold"><%= t(".challenges_faced") %>:</span>
                  <p class="text-sm mt-1"><%= @task_assignment.submission_data["challenges_faced"] %></p>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Attachments Display -->
          <% if @task_assignment.attachments.any? %>
            <div class="mt-4 pt-4 border-t border-gray">
              <h3 class="font-semibold mb-3 flex items-center gap-2">
                <%= icon "attachment-line", class: "w-5 h-5", role: "img" %>
                <%= t(".attachments") %> (<%= @task_assignment.attachments.count %>)
              </h3>
              <div class="space-y-2">
                <% @task_assignment.attachments.each do |attachment| %>
                  <div class="flex items-center gap-3 p-3 bg-gray-50 rounded hover:bg-gray-100 transition">
                    <%= icon "file-3-line", class: "w-5 h-5 text-primary", role: "img" %>
                    <div class="flex-1 min-w-0">
                      <p class="font-medium truncate"><%= attachment.title[I18n.locale.to_s] || attachment.title.values.first %></p>
                      <p class="text-sm opacity-75">
                        <%= number_to_human_size(attachment.file_size) %> • <%= attachment.content_type %>
                      </p>
                    </div>
                    <% if attachment.file.attached? %>
                      <%= link_to main_app.rails_blob_path(attachment.file, disposition: "attachment"),
                                 class: "button button__sm button__transparent-secondary",
                                 target: "_blank" do %>
                        <%= icon "download-line", class: "w-4 h-4", role: "img" %>
                        <%= t(".download") %>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @task_assignment.submitted_at %>
            <div class="mt-4 text-sm opacity-75">
              <%= icon "calendar-line", class: "w-4 h-4 mr-1", role: "img" %>
              <%= t(".submitted_on", date: l(@task_assignment.submitted_at, format: :long)) %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>
</div>
