<% add_decidim_page_title(t(".title")) %>

<!-- Volunteer Dashboard with Decidim Native Components -->
<div class="volunteer-dashboard-container fade-in">

  <!-- Profile Header Section -->
  <div class="dashboard-header">
    <% if current_volunteer_profile %>
      <%= cell("decidim/volunteer_scheduler/profile_stats", current_volunteer_profile) %>
    <% else %>
      <div class="callout warning">
        <div class="flex items-center gap-3">
          <%= icon "loader-3-line", class: "w-5 h-5 animate-spin", role: "img" %>
          <p><%= t(".profile_creating", default: "Настройка профиля волонтёра...") %></p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- Available Tasks Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <%= icon "check-line", role: "img" %>
          <%= t(".available_tasks") %>
        </h2>
        <span class="section-badge">
          <%= @available_tasks.count %>
        </span>
      </div>

      <div class="task-cards-grid">
        <div class="card__grid-grid">
          <% if @available_tasks.any? %>
            <% @available_tasks.each do |task| %>
              <%= cell("decidim/volunteer_scheduler/task_card", task) %>
            <% end %>
          <% else %>
            <div class="empty-state">
              <%= icon "checkbox-circle-line", class: "empty-icon", role: "img" %>
              <h3 class="empty-title"><%= t(".no_available_tasks") %></h3>
              <p class="empty-description">
                <%= t(".check_back_later", default: "Загляните позже за новыми заданиями!") %>
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- My Assignments Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <%= icon "list-check", role: "img" %>
          <%= t(".my_assignments") %>
        </h2>
        <div class="flex items-center gap-3">
          <span class="section-badge">
            <%= @my_assignments.count %>
          </span>
          <%= link_to task_assignments_path, class: "button button__sm button__transparent-secondary" do %>
            <%= t(".view_all_assignments") %>
            <%= icon "arrow-right-line", class: "w-4 h-4 ml-1", role: "img" %>
          <% end %>
        </div>
      </div>

      <div class="task-assignments-list">
        <div class="card__list-list space-y-3">
          <% if @my_assignments.any? %>
            <% @my_assignments.limit(5).each do |assignment| %>
              <%= link_to task_assignment_path(assignment), class: "card__list assignment-status #{assignment.status}" do %>
                <div class="card__list-content">
                  <h4 class="card__list-title"><%= assignment.task_template.title %></h4>
                  <p class="card__list-text line-clamp-2"><%= truncate(assignment.task_template.description, length: 100) %></p>

                  <div class="card__list-metadata">
                    <!-- Status -->
                    <div class="flex items-center gap-1">
                      <span class="label <%= assignment_status_class(assignment) %>">
                        <%= icon assignment_status_icon(assignment), class: "w-3 h-3", role: "img" %>
                        <%= t("decidim.volunteer_scheduler.task_assignments.status.#{assignment.status}") %>
                      </span>
                    </div>

                    <!-- XP Reward -->
                    <div class="flex items-center gap-1">
                      <%= icon "star-line", class: "w-3 h-3 text-warning", role: "img" %>
                      <span class="text-sm"><%= assignment.task_template.xp_reward %> <%= t("decidim.volunteer_scheduler.common.xp") %></span>
                    </div>

                    <!-- Due Date -->
                    <% if assignment.due_date %>
                      <div class="flex items-center gap-1">
                        <%= icon "calendar-line", class: "w-3 h-3", role: "img" %>
                        <span class="text-sm"><%= t(".due_date", date: l(assignment.due_date, format: :short)) %></span>
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="card__list-action">
                  <%= icon "arrow-right-s-line", class: "w-5 h-5", role: "img" %>
                </div>
              <% end %>
            <% end %>

            <% if @my_assignments.count > 5 %>
              <div class="text-center pt-4">
                <%= link_to task_assignments_path, class: "button button__sm button__transparent-secondary" do %>
                  <%= t(".view_all_assignments") %>
                  <%= icon "arrow-right-line", class: "w-4 h-4 ml-2", role: "img" %>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="empty-state">
              <%= icon "list-check", class: "empty-icon", role: "img" %>
              <h3 class="empty-title"><%= t(".no_assignments") %></h3>
              <p class="empty-description">
                <%= t(".start_by_accepting", default: "Начните с принятия задания выше!") %>
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Statistics Grid -->
  <div class="dashboard-grid mt-8">

    <!-- Referral Stats Section -->
    <div class="dashboard-section">
      <div class="card">
        <div class="card__content p-6">
          <div class="section-header mb-6">
            <h3 class="text-xl font-bold flex items-center gap-3">
              <%= icon "user-smile-line", class: "w-6 h-6 text-primary", role: "img" %>
              <%= t(".referral_stats") %>
            </h3>
            <%= icon "share-line", class: "w-5 h-5 opacity-40", role: "img" %>
          </div>

          <!-- Referral Stats Grid -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="text-center p-4 bg-secondary/5 rounded-lg border-2 border-secondary/20">
              <div class="text-3xl font-bold text-secondary mb-1">
                <%= @referral_stats[:total_referrals] %>
              </div>
              <p class="text-sm font-medium opacity-75">
                <%= t(".total_referrals") %>
              </p>
            </div>

            <div class="text-center p-4 bg-success/5 rounded-lg border-2 border-success/20">
              <div class="text-3xl font-bold text-success mb-1">
                <%= @referral_stats[:active_referrals] %>
              </div>
              <p class="text-sm font-medium opacity-75">
                <%= t(".active_referrals") %>
              </p>
            </div>
          </div>

          <!-- Commission Earned -->
          <div class="referral-commission-badge">
            <div class="text-center">
              <div class="flex items-center justify-center gap-2 mb-2">
                <%= icon "star-line", class: "w-6 h-6", role: "img" %>
                <span class="commission-amount">
                  <%= number_to_currency(@referral_stats[:total_commission], unit: "", precision: 0) %>
                </span>
                <span class="commission-label"><%= t("decidim.volunteer_scheduler.common.tokens") %></span>
              </div>
              <p class="text-sm font-medium">
                <%= t(".total_commission_earned") %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity Section -->
    <div class="dashboard-section">
      <div class="card">
        <div class="card__content p-6">
          <div class="section-header mb-6">
            <h3 class="text-xl font-bold flex items-center gap-3">
              <%= icon "time-line", class: "w-6 h-6 text-primary", role: "img" %>
              <%= t(".recent_activity") %>
            </h3>
            <%= icon "time-line", class: "w-5 h-5 opacity-40", role: "img" %>
          </div>

          <div class="activity-feed space-y-2">
            <% if @recent_transactions.any? %>
              <% @recent_transactions.each do |transaction| %>
                <div class="activity-item">
                  <div class="activity-icon-wrapper <%= transaction.is_earning? ? 'earning' : 'spending' %>">
                    <%= icon(transaction.is_earning? ? "arrow-up-line" : "arrow-down-line", class: "w-5 h-5", role: "img") %>
                  </div>

                  <div class="activity-content">
                    <p class="activity-description"><%= transaction.description %></p>
                    <p class="activity-timestamp"><%= l(transaction.created_at, format: :short) %></p>
                  </div>

                  <div class="activity-amount <%= transaction.is_earning? ? 'positive' : 'negative' %>">
                    <%= transaction.formatted_amount %>
                    <%= transaction.xp_amount ? t("decidim.volunteer_scheduler.common.xp") : t("decidim.volunteer_scheduler.common.tokens") %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="empty-state">
                <%= icon "time-line", class: "empty-icon", role: "img" %>
                <h4 class="empty-title"><%= t(".no_recent_activity") %></h4>
                <p class="empty-description">
                  <%= t(".activity_will_appear", default: "Ваша активность появится здесь") %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
